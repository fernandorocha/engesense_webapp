<% 
  // Set page-specific variables for the layout
  const pageTitle = 'User Management';
  const currentPage = 'users';
  
  // Main content for this page
  const body = `
    <header style="margin-bottom: var(--md-spacing-xl);">
      <h2 class="md-headline-3" style="color: var(--md-primary); margin: 0;">User Management</h2>
      <p style="color: var(--md-on-surface-variant); margin-top: var(--md-spacing-sm);">
        Manage user accounts and their access permissions
      </p>
    </header>

    ${error ? `
      <div class="error-message">
        ${typeof needsMigration !== 'undefined' && needsMigration ? `
          <strong>‚ö†Ô∏è Database Migration Required</strong><br>
          Your database needs to be upgraded to use the new user management features.<br><br>
          <strong>Run this command to upgrade:</strong><br>
          <code style="background: rgba(0,0,0,0.1); padding: 4px 8px; border-radius: 4px; font-family: monospace;">node scripts/migrate.js</code><br><br>
          This will safely add new fields while preserving all existing user data.
        ` : `
          <strong>Error:</strong> ${error}
        `}
      </div>
    ` : ''}

    ${success ? `
      <div class="success-message">
        <strong>Success:</strong> ${success}
      </div>
    ` : ''}

    <div class="md-card md-elevation-1" style="padding: var(--md-spacing-xl); margin-bottom: var(--md-spacing-xl);">
      <h3 class="section-title">Existing Users</h3>
      <table class="data-table">
        <thead>
          <tr>
            <th>User ID</th>
            <th>Username</th>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Organization</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${users.map(u => `
            <tr>
              <td>${u.id}</td>
              <td><strong>${u.username}</strong></td>
              <td>${[u.first_name, u.last_name].filter(n => n).join(' ') || '-'}</td>
              <td>${u.email || '-'}</td>
              <td>
                <span class="${u.role === 'admin' ? 'md-text-primary' : ''}" style="font-weight: ${u.role === 'admin' ? 'var(--md-font-weight-medium)' : 'var(--md-font-weight-regular)'};">
                  ${u.role}
                </span>
              </td>
              <td>${u.organization_name || '-'}</td>
              <td>
                <span class="${u.status === 'active' ? 'md-text-success' : u.status === 'suspended' ? 'md-text-error' : ''}" style="font-weight: var(--md-font-weight-medium);">
                  ${u.status || 'active'}
                </span>
              </td>
              <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
              <td>
                <div class="action-buttons">
                  <a href="/admin/users/${u.id}/edit" class="action-btn edit-btn" title="Edit User">
                    <span class="md-icon md-icon-sm">‚úèÔ∏è</span>
                  </a>
                  <button type="button" class="action-btn delete-btn" title="Delete User" onclick="confirmDelete(${u.id}, '${u.username}')">
                    <span class="md-icon md-icon-sm">üóëÔ∏è</span>
                  </button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>

    ${!(typeof needsMigration !== 'undefined' && needsMigration) ? `
    <div class="md-card md-elevation-1" style="padding: var(--md-spacing-xl);">
      <h3 class="section-title">Create New User</h3>
      <form method="POST" action="/admin/users" class="admin-form">
        <div class="form-field">
          <label class="md-input-label" for="username">Username *</label>
          <input 
            id="username"
            name="username" 
            class="md-input" 
            placeholder="Enter username" 
            required 
          />
        </div>
        
        <div class="form-field">
          <label class="md-input-label" for="password">Password *</label>
          <input 
            id="password"
            name="password" 
            type="password" 
            class="md-input"
            placeholder="Enter password" 
            required 
          />
        </div>
        
        <div class="form-field">
          <label class="md-input-label" for="first_name">First Name</label>
          <input 
            id="first_name"
            name="first_name" 
            class="md-input" 
            placeholder="Enter first name"
          />
        </div>
        
        <div class="form-field">
          <label class="md-input-label" for="last_name">Last Name</label>
          <input 
            id="last_name"
            name="last_name" 
            class="md-input" 
            placeholder="Enter last name"
          />
        </div>
        
        <div class="form-field">
          <label class="md-input-label" for="email">Email</label>
          <input 
            id="email"
            name="email" 
            type="email"
            class="md-input" 
            placeholder="Enter email address"
          />
        </div>
        
        <div class="form-field">
          <label class="md-input-label" for="phone">Phone</label>
          <input 
            id="phone"
            name="phone" 
            type="tel"
            class="md-input" 
            placeholder="Enter phone number"
          />
        </div>
        
        <div class="form-field">
          <label class="md-input-label" for="job_title">Job Title</label>
          <input 
            id="job_title"
            name="job_title" 
            class="md-input" 
            placeholder="Enter job title"
          />
        </div>
        
        <div class="form-field">
          <label class="md-input-label" for="role">Role *</label>
          <select id="role" name="role" class="form-select" required>
            <option value="client">Client</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        
        <div class="form-field">
          <label class="md-input-label" for="organization_id">Organization *</label>
          <select id="organization_id" name="organization_id" class="form-select" required>
            <option value="">Select Organization</option>
            ${organizations.map(org => `
              <option value="${org.id}">${org.name}</option>
            `).join('')}
          </select>
        </div>
        
        <button type="submit" class="md-button md-button-filled submit-button">
          <span class="md-icon md-icon-sm">üë§</span>
          Create User
        </button>
      </form>
    </div>
    ` : ''}

    <!-- Hidden form for delete confirmation -->
    <form id="deleteForm" method="POST" style="display: none;">
      <input type="hidden" name="_method" value="DELETE">
    </form>

    <style>
      .action-buttons {
        display: flex;
        gap: var(--md-spacing-xs);
        justify-content: center;
      }
      
      .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        border-radius: var(--md-radius-sm);
        cursor: pointer;
        transition: all var(--md-transition-fast);
        text-decoration: none;
        font-size: 14px;
      }
      
      .edit-btn {
        background-color: var(--md-primary);
        color: var(--md-on-primary);
      }
      
      .edit-btn:hover {
        background-color: var(--md-primary-dark);
        color: var(--md-on-primary);
        text-decoration: none;
      }
      
      .delete-btn {
        background-color: var(--md-error);
        color: var(--md-on-error);
      }
      
      .delete-btn:hover {
        background-color: var(--md-error-dark, #c62828);
      }
      
      @media (max-width: 768px) {
        .action-buttons {
          flex-direction: column;
          gap: var(--md-spacing-2xs);
        }
        
        .action-btn {
          width: 28px;
          height: 28px;
          font-size: 12px;
        }
      }
    </style>

    <script>
      function confirmDelete(userId, username) {
        if (confirm('Are you sure you want to delete user "' + username + '"? This action cannot be undone.')) {
          const form = document.getElementById('deleteForm');
          form.action = '/admin/users/' + userId + '/delete';
          form.submit();
        }
      }
    </script>
  `;
%>

<%- include('./partials/admin_layout', { pageTitle, currentPage, body }) %>
