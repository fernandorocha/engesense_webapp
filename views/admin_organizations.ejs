<% 
  // Set page-specific variables for the layout
  const pageTitle = 'Organization Management';
  const currentPage = 'organizations';
  
  // Main content for this page
  const body = `
    <header style="margin-bottom: var(--md-spacing-xl);">
      <h2 class="md-headline-3" style="color: var(--md-primary); margin: 0;">Organization Management</h2>
      <p style="color: var(--md-on-surface-variant); margin-top: var(--md-spacing-sm);">
        Manage organizations and their InfluxDB configurations
      </p>
    </header>

    ${error ? `
      <div class="error-message">
        ${typeof needsMigration !== 'undefined' && needsMigration ? `
          <strong>‚ö†Ô∏è Database Migration Required</strong><br>
          Your database needs to be upgraded to use the new organization management features.<br><br>
          <strong>Run this command to upgrade:</strong><br>
          <code style="background: rgba(0,0,0,0.1); padding: 4px 8px; border-radius: 4px; font-family: monospace;">node scripts/migrate.js</code><br><br>
          This will safely add new fields while preserving all existing data.
        ` : `
          <strong>Error:</strong> ${error}
        `}
      </div>
    ` : ''}

    ${success ? `
      <div class="success-message">
        <strong>Success:</strong> ${success}
      </div>
    ` : ''}

    <div class="md-card md-elevation-1" style="padding: var(--md-spacing-xl); margin-bottom: var(--md-spacing-xl);">
      <h3 class="section-title">Existing Organizations</h3>
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Description</th>
            <th>InfluxDB Token</th>
            <th>Created</th>
            <th>Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${organizations.map(org => `
            <tr>
              <td>${org.id}</td>
              <td><strong>${org.name}</strong></td>
              <td>${org.description || '-'}</td>
              <td>
                <span style="font-family: monospace; font-size: 0.85em; color: var(--md-on-surface-variant);">
                  ${org.influx_token ? (org.influx_token.substring(0, 20) + '...') : 'Not set'}
                </span>
              </td>
              <td>${org.created_at ? new Date(org.created_at).toLocaleDateString() : '-'}</td>
              <td>${org.updated_at ? new Date(org.updated_at).toLocaleDateString() : '-'}</td>
              <td style="white-space: nowrap;">
                <a href="/admin/organizations/${org.id}/edit" class="md-button md-button-outlined" style="color: var(--md-primary); border-color: var(--md-primary); font-size: 0.8em; padding: 4px 8px; margin-right: 8px; text-decoration: none; display: inline-block;">
                  Edit
                </a>
                ${org.id !== 1 ? `
                  <form method="POST" action="/admin/organizations/${org.id}/delete" style="display: inline;" 
                        onsubmit="return confirm('Are you sure you want to delete this organization? This action cannot be undone.')">
                    <button type="submit" class="md-button md-button-outlined" style="color: var(--md-error); border-color: var(--md-error); font-size: 0.8em; padding: 4px 8px;">
                      Delete
                    </button>
                  </form>
                ` : '<span style="color: var(--md-on-surface-variant); font-size: 0.8em; margin-left: 8px;">Default</span>'}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>

    ${!(typeof needsMigration !== 'undefined' && needsMigration) ? `
    <div class="md-card md-elevation-1" style="padding: var(--md-spacing-xl);">
      <h3 class="section-title">Create New Organization</h3>
      <form method="POST" action="/admin/organizations" class="admin-form">
        <div class="form-field">
          <label class="md-input-label" for="name">Organization Name *</label>
          <input 
            id="name"
            name="name" 
            class="md-input" 
            placeholder="Enter organization name" 
            required 
          />
        </div>
        
        <div class="form-field">
          <label class="md-input-label" for="description">Description</label>
          <input 
            id="description"
            name="description" 
            class="md-input" 
            placeholder="Enter organization description"
          />
        </div>
        
        <div class="form-field">
          <label class="md-input-label" for="influx_token">InfluxDB Token *</label>
          <input 
            id="influx_token"
            name="influx_token" 
            class="md-input" 
            placeholder="Enter InfluxDB access token"
            required
            style="font-family: monospace; font-size: 0.9em;"
          />
        </div>
        
        <button type="submit" class="md-button md-button-filled submit-button">
          <span class="md-icon md-icon-sm">üè¢</span>
          Create Organization
        </button>
      </form>
      
      <div style="margin-top: var(--md-spacing-lg); padding: var(--md-spacing-md); background-color: rgba(25, 118, 210, 0.1); border-radius: var(--md-radius-sm); border-left: 4px solid var(--md-primary);">
        <p style="margin: 0; font-size: var(--md-font-size-body2); color: var(--md-on-surface);">
          <strong>‚ÑπÔ∏è Note:</strong> All organizations use the same InfluxDB server URL (${process.env.INFLUX_URL || 'configured in environment'}). 
          Each organization requires its own access token for data isolation.
        </p>
      </div>
    </div>
    ` : ''}
  `;
%>

<%- include('./partials/admin_layout', { pageTitle, currentPage, body }) %>